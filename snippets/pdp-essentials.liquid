{% comment %}
  Renders essential product information such as delivery, returns, size & fit and a trust line.

  Accepts:
  - block: {Object} block object containing settings for the snippet.
  - product: {Object} product object (unused).
  - localization: {Object} localization object (unused).

  Usage:
  {% render 'pdp-essentials', block: block, product: product, localization: localization %}
{% endcomment %}
<div data-component="pdp-essentials" {{ block.shopify_attributes }} data-link-behavior="{{ block.settings.link_behavior | default: 'modal' }}">
  {% liquid
    assign layout = block.settings.layout_style | default: 'bar'
    assign compact = block.settings.compact_mode
    assign dividers = block.settings.show_dividers
    assign use_metafields = block.settings.use_metafields

    assign delivery_title = blank
    if use_metafields
      if localization.country.iso_code == 'IN' and product.metafields.custom.delivery_text_in != blank
        assign delivery_title = product.metafields.custom.delivery_text_in
      elsif product.metafields.custom.delivery_text_global != blank
        assign delivery_title = product.metafields.custom.delivery_text_global
      else
        assign delivery_title = product.metafields.custom.delivery_text
      endif
    endif
    if delivery_title == blank
      if localization.country.iso_code == 'IN' and block.settings.delivery_text_in != blank
        assign delivery_title = block.settings.delivery_text_in
      elsif block.settings.delivery_text_global != blank
        assign delivery_title = block.settings.delivery_text_global
      else
        assign delivery_title = block.settings.delivery_text
      endif
    endif

    assign returns_title = blank
    if use_metafields
      assign returns_title = product.metafields.custom.returns_text
    endif
    if returns_title == blank
      assign returns_title = block.settings.returns_text
    endif

    assign delivery_details = block.settings.delivery_details
    assign returns_details = block.settings.returns_details
    assign size_text = 'sections.pdp_essentials.size_and_fit' | t
    assign hide_if_empty = block.settings.hide_if_empty

    assign delivery_title = delivery_title | default: 'sections.pdp_essentials.delivery'
    assign returns_title = returns_title | default: 'sections.pdp_essentials.returns'
    assign delivery_details = delivery_details | default: 'sections.pdp_essentials.delivery_details'
    assign returns_details = returns_details | default: 'sections.pdp_essentials.returns_details'

    assign delivery_title = delivery_title | t
    assign returns_title = returns_title | t
    assign delivery_details = delivery_details | t
    assign returns_details = returns_details | t
  %}

  {%- assign show_delivery = delivery_title != blank or delivery_details != blank -%}
  {%- if hide_if_empty and delivery_title == blank -%}
    {%- assign show_delivery = false -%}
  {%- endif -%}

  {%- assign show_returns = returns_title != blank or returns_details != blank -%}
  {%- if hide_if_empty and returns_title == blank -%}
    {%- assign show_returns = false -%}
  {%- endif -%}

  {%- assign show_size_link = block.settings.show_size_link and block.settings.size_guide_page != blank -%}
  {%- if hide_if_empty and size_text == blank -%}
    {%- assign show_size_link = false -%}
  {%- endif -%}

  {%- if show_delivery and delivery_details != blank -%}
    <div id="pdp-delivery-details" hidden>{{ delivery_details }}</div>
  {%- endif -%}
  {%- if show_returns and returns_details != blank -%}
    <div id="pdp-returns-details" hidden>{{ returns_details }}</div>
  {%- endif -%}

  {% case layout %}
    {% when 'cards' %}
      <ul style="display:flex;flex-wrap:wrap;list-style:none;margin:0;padding:0;gap:{% if compact %}4px{% else %}8px{% endif %};">
        {%- if show_delivery -%}
          <li style="{% if dividers %}border:1px solid currentColor;{% endif %}border-radius:9999px;padding:{% if compact %}2px 8px{% else %}4px 12px{% endif %};">
            <button type="button" data-essentials-trigger aria-controls="pdp-delivery-details" style="all:unset;cursor:pointer;">{{ delivery_title }}</button>
          </li>
        {%- endif -%}

        {%- if show_returns -%}
          <li style="{% if dividers %}border:1px solid currentColor;{% endif %}border-radius:9999px;padding:{% if compact %}2px 8px{% else %}4px 12px{% endif %};">
            <button type="button" data-essentials-trigger aria-controls="pdp-returns-details" style="all:unset;cursor:pointer;">{{ returns_title }}</button>
          </li>
        {%- endif -%}

        {%- if show_size_link -%}
          <li style="{% if dividers %}border:1px solid currentColor;{% endif %}border-radius:9999px;padding:{% if compact %}2px 8px{% else %}4px 12px{% endif %};">
            <a href="{{ block.settings.size_guide_page.url }}"{% unless block.settings.link_behavior == 'modal' %} target="_blank" rel="noopener"{% endunless %} data-size-guide-link data-event="pdp_essentials_click" data-item="size">{{ size_text }}</a>
          </li>
        {%- endif -%}
      </ul>

    {% when 'accordion' %}
      <div style="margin:0;padding:0;">
        {%- if show_delivery -%}
          <div style="padding:{% if compact %}4px 0{% else %}8px 0{% endif %};{% if dividers %}border-bottom:1px solid currentColor;{% endif %}">
            <button type="button" data-essentials-trigger aria-controls="pdp-delivery-details" style="all:unset;cursor:pointer;">{{ delivery_title }}</button>
          </div>
        {%- endif -%}

        {%- if show_returns -%}
          <div style="padding:{% if compact %}4px 0{% else %}8px 0{% endif %};{% if dividers %}border-bottom:1px solid currentColor;{% endif %}">
            <button type="button" data-essentials-trigger aria-controls="pdp-returns-details" style="all:unset;cursor:pointer;">{{ returns_title }}</button>
          </div>
        {%- endif -%}

        {%- if show_size_link -%}
          <div style="padding:{% if compact %}4px 0{% else %}8px 0{% endif %};{% if dividers %}border-bottom:1px solid currentColor;{% endif %}">
            <a href="{{ block.settings.size_guide_page.url }}"{% unless block.settings.link_behavior == 'modal' %} target="_blank" rel="noopener"{% endunless %} data-size-guide-link data-event="pdp_essentials_click" data-item="size">{{ size_text }}</a>
          </div>
        {%- endif -%}
      </div>

    {% else %}
      <ul style="display:flex;flex-wrap:wrap;list-style:none;margin:0;padding:0;gap:{% if compact %}4px{% else %}8px{% endif %};{% if dividers %}border-top:1px solid currentColor;border-bottom:1px solid currentColor;{% endif %}">
        {%- if show_delivery -%}
          <li style="padding:{% if compact %}4px 8px{% else %}8px 12px{% endif %};{% if dividers %}border-right:1px solid currentColor;{% endif %}">
            <button type="button" data-essentials-trigger aria-controls="pdp-delivery-details" style="all:unset;cursor:pointer;">{{ delivery_title }}</button>
          </li>
        {%- endif -%}

        {%- if show_returns -%}
          <li style="padding:{% if compact %}4px 8px{% else %}8px 12px{% endif %};{% if dividers %}border-right:1px solid currentColor;{% endif %}">
            <button type="button" data-essentials-trigger aria-controls="pdp-returns-details" style="all:unset;cursor:pointer;">{{ returns_title }}</button>
          </li>
        {%- endif -%}

        {%- if show_size_link -%}
          <li style="padding:{% if compact %}4px 8px{% else %}8px 12px{% endif %};">
            <a href="{{ block.settings.size_guide_page.url }}"{% unless block.settings.link_behavior == 'modal' %} target="_blank" rel="noopener"{% endunless %} data-size-guide-link data-event="pdp_essentials_click" data-item="size">{{ size_text }}</a>
          </li>
        {%- endif -%}
      </ul>
  {% endcase %}

  {%- assign trust_line_setting = block.settings.trust_line -%}
  {%- if trust_line_setting == blank and hide_if_empty -%}
    {%- assign trust_line_text = blank -%}
  {%- else -%}
    {%- assign trust_line_text = trust_line_setting | default: 'sections.pdp_essentials.trust_line' -%}
    {%- assign trust_line_text = trust_line_text | t -%}
  {%- endif -%}
  {%- if trust_line_text != blank -%}
    <div class="pdp-essentials__trust-line" title="{{ trust_line_text | escape }}">{{ trust_line_text }}</div>
  {%- endif -%}

  <script>
    (function(){
      var container=document.currentScript.parentElement;
      var triggers=container.querySelectorAll('[data-essentials-trigger]');
      var mobile=matchMedia('(hover: none)').matches;
      var supportsModal=typeof HTMLDialogElement==='function';
      var linkBehavior=container.dataset.linkBehavior;
      var modal,focusEls,first,last;
      function trap(e){if(e.key==='Tab'){if(e.shiftKey&&document.activeElement===first){e.preventDefault();last.focus();}else if(!e.shiftKey&&document.activeElement===last){e.preventDefault();first.focus();}}}
      function openModal(content){if(!modal){modal=document.createElement('dialog');modal.dataset.event='pdp_essentials_modal';modal.innerHTML='<button data-close>Ã—</button><div></div>';modal.querySelector('[data-close]').onclick=closeModal;document.body.appendChild(modal);}modal.querySelector('div').innerHTML=content;modal.showModal();focusEls=[...modal.querySelectorAll('a,button,input,select,textarea,[tabindex]:not([tabindex="-1"])')];first=focusEls[0];last=focusEls[focusEls.length-1];modal.addEventListener('keydown',trap);}
      function closeModal(){if(modal){modal.close();modal.removeEventListener('keydown',trap);}}
      function openNewTab(content){var w=window.open('','_blank');w.document.write(content);}
      triggers.forEach(function(t){var id=t.getAttribute('aria-controls');var html=document.getElementById(id)?.innerHTML||'';if(mobile){t.addEventListener('click',function(e){e.preventDefault();if(linkBehavior==='modal'&&supportsModal){openModal(html);}else{openNewTab(html);}});}else{var tip;function show(){tip=tip||document.createElement('div');tip.className='pdp-essentials__tooltip';tip.innerHTML=html;document.body.appendChild(tip);var r=t.getBoundingClientRect();tip.style.position='absolute';tip.style.top=(r.bottom+window.scrollY)+'px';tip.style.left=(r.left+window.scrollX)+'px';tip.hidden=false;}function hide(){if(tip)tip.hidden=true;}t.addEventListener('mouseenter',show);t.addEventListener('focus',show);t.addEventListener('mouseleave',hide);t.addEventListener('blur',hide);}});
      var sizeLink=container.querySelector('[data-size-guide-link]');
      if(sizeLink){sizeLink.addEventListener('click',function(e){if(linkBehavior==='modal'&&supportsModal){e.preventDefault();fetch(sizeLink.href).then(function(r){return r.text();}).then(function(html){var doc=new DOMParser().parseFromString(html,'text/html');openModal(doc.body.innerHTML);});}});}
      document.addEventListener('keydown',function(e){if(e.key==='Escape')closeModal();});
    })();
  </script>
</div>
